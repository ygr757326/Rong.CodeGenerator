@using System
@using System.Collections.Generic
@using System.Linq
@using System.Text
@using Rong.Volo.Abp.CodeGenerator.Vue.Models.Pages
@inherits Volo.Abp.TextTemplating.Razor.RazorTemplatePageBase<TemplateVuePageModifyModel>
@{
    var hasEditor = Model.Form.Any(a => a.IsEditor);
    // var hasTinymceEditor = hasEditor && (Model.EntityInfo.Options.EditorComponent == null || Model.EntityInfo.Options.EditorComponent == "Tinymce");
    // string? useComponentRegister = hasTinymceEditor ? ", useComponentRegister" : null;
    // string? useTinymce = hasTinymceEditor ? "import { Tinymce } from '@/components/Tinymce/index';" : null;
    // string? registerTinymce = hasTinymceEditor ? "useComponentRegister('Tinymce', Tinymce);" : null;
    string? width = hasEditor ? "85%" : "40%";

    List<string> distinct = new List<string>();
    StringBuilder builder = new StringBuilder();
    if (Model.Form != null)
    {
        foreach (var item in Model.Form.Where(a => a.IsApiSelect).Distinct())
        {
            string d = $"import {{ {item.ApiSelectEntity}{item.ApiSelectApiName} }} from '#/views/{item.ApiSelectEntityCase}/api';";
            if (distinct.All(a => a != d))
            {
                builder.AppendLine(d);
            }
            distinct.Add(d);
        }
    }

    string apis = builder.ToString();
}
<script lang="ts" setup>
import { computed } from 'vue';
import { useVbenForm } from '#/adapter/form';
import type { VbenFormSchema } from '#/adapter/form';
import { useVbenDrawer } from '@@vben/common-ui';
import { message } from 'ant-design-vue';

import { @{@Model.EntityInfo.Entity}Get, @{@Model.EntityInfo.Entity}Update } from '../api';
@apis

const emits = defineEmits(['success']);

/**
 * 标题
 */
const getTitle = computed(() => {
  return '编辑 - @Model.EntityInfo.EntityName';
});

/**
 * 表单
 */
function useFormSchema(): VbenFormSchema[] {
  return [
@Model.FormTemplate
  ];
}

/**
 * 表单配置
 */
const [Form, formApi] = useVbenForm({
  schema: useFormSchema(),
  showDefaultActions: false,
  scrollToFirstError: true,
  // wrapperClass
});

/**
 * 抽屉
 */
const [Drawer, drawerApi] = useVbenDrawer({
  /**
   * 确定按钮的回调
   */
  async onConfirm() {
    // 验证
    const { valid } = await formApi.validate();
    if (!valid) return;
    // 加载中
    drawerApi.lock();
    // 获取
    const values = await formApi.getValues();
    // 保存
    @{@Model.EntityInfo.Entity}Update(values.id, values)
      .then(() => {
        message.success('修改成功');
        emits('success');
        drawerApi.close();
      })
      .finally(() => {
        drawerApi.unlock();
      });
  },
  /**
   * 弹窗状态变化回调
   * @@param isOpen 是否打开
   */
  async onOpenChange(isOpen) {
    if (isOpen) {
      // 获取传参
      const payload = drawerApi.getData();
      // 重置表单
      await formApi.resetForm();
      // 获取详情
      const res = await getData(payload.id);
      // 设置表单值
      formApi.setValues(res as any);
    }
  },
});

/*
* 获取详情
/*/
async function getData(id: any) {
  drawerApi.lock();
  try {
    const res = await @{@Model.EntityInfo.Entity}Get(id);
    return res;
  } finally {
    drawerApi.unlock();
  }
}
</script>

<template>
  <Drawer :title="getTitle" class="w-[@width]">
    <Form />
  </Drawer>
</template>

<style lang="css" scoped></style>
