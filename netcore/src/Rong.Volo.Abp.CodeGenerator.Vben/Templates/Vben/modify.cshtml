@using System.Linq
@using Rong.Volo.Abp.CodeGenerator.Vue.Models.Pages
@inherits Volo.Abp.TextTemplating.Razor.RazorTemplatePageBase<TemplateVuePageModifyModel>
@{
    var hasEditor = Model.Form.Any(a => a.IsEditor);
    var hasTinymceEditor = hasEditor && (Model.EntityInfo.Options.EditorComponent == null || Model.EntityInfo.Options.EditorComponent == "Tinymce");
    string? useComponentRegister = hasTinymceEditor ? ", useComponentRegister" : null;
    string? useTinymce = hasTinymceEditor ? "import { Tinymce } from '@/components/Tinymce/index';" : null;
    string? registerTinymce = hasTinymceEditor ? "useComponentRegister('Tinymce', Tinymce);" : null;
    string? width = hasEditor ? "85%" : "800px";
}
<template>
  <a-drawer v-model:visible="visible" title="编辑 - @Model.EntityInfo.EntityName" width="@width">
  <template #extra>
    <a-button @@click="visible = false">取消</a-button>
    <a-button @@click="handleSubmit" type="primary" style="margin-left: 20px">提交</a-button>
  </template>
  <div ref="modifyFormRef">
    <BasicForm @@register="Register" v-if="visible">
    </BasicForm>
  </div>
</a-drawer>
</template>

<script lang="ts" setup>

import { nextTick, ref } from 'vue';
import { @{@Model.EntityInfo.Entity}Get, @{@Model.EntityInfo.Entity}Update } from '../api';
import { BasicForm, FormSchema, useForm @useComponentRegister } from '@@/components/Form/index';
import { useLoading } from '@@/components/Loading';
import { useDictStore } from '@@/store/modules/dict';
import { useEnumStore } from '@@/store/modules/enum';
@useTinymce
@registerTinymce
const dictStore = useDictStore();
const enumStore = useEnumStore();

const modifyFormRef = ref(null);

const [openWrapLoading, closeWrapLoading] = useLoading({
  target: modifyFormRef,
  props: {
    absolute: true,
  },
});

const visible = ref<boolean>(false);
const $emit = defineEmits(['success']);

/**
 * 表单
 */
const schemas: FormSchema[] = [
@Model.FormTemplate
];

/**
 * 表单配置
 */
const [Register, { validateFields, getFieldsValue, setFieldsValue, resetFields }] = useForm({
  labelWidth: 120,
  schemas,
  actionColOptions: {
    span: 12,
  },
  baseColProps: {
    span: 24,
  },
  // 是否显示操作按钮
  showActionButtonGroup: false,
});


/**
 * 提交表单 - 修改
 */
async function handleSubmit() {
  //验证
  await validateFields();
  //获取
  const data: any = getFieldsValue();
  //修改
  await @{@Model.EntityInfo.Entity}Update(data.id, data);

  visible.value = false;
  $emit('success');
}

/*
* 获取详情
/*/
async function getData(data) {
  @{@Model.EntityInfo.Entity}Get(data.id).then((res) => {
      setFieldsValue(res);
  })
  .finally(() => {
      closeWrapLoading();
    });
}

/**
 * 弹框
 */
function open(data) {
  visible.value = true;
  nextTick(() => {
    resetFields();
  });
  openWrapLoading();
  getData({ id: data.id });
}
defineExpose({ open });

</script>
